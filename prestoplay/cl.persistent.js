(function(){var g={}; var _ = _ || {}
var f=function(window){var by="A persistent DRM session already exists for: ",cy="No DRM configuration.",dy="clpp.persistent",ey="clpp.persistent.SimpleSessionStorage",fy=function(a,b){for(var c=[],d=_.u(a),e=d.next();!e.done;e=d.next())c.push(b(e.value));return c},gy=function(a){a=a.f.keys();a=fy(a,function(b){return b.sessionId});return Array.from(a)},hy=function(a,b){var c,d,e;return _.E(function(f){if(1==f.a)return _.x(f,_.Zn(a,b),2);c=f.f;if(!c)return a.g.debug("Ignoring attempt to remove missing session",b),f["return"]();
d=[];(e=a.f.get(c))&&a.B&&(e.tb=new _.wj,d.push(e.tb));a.g.debug("Attempting to remove session",b);d.push(c.remove());return f["return"](Promise.all(d))})},jy=function(a,b){a.J=iy;a.K=[];a.G=!0;return _.Gn(a,b)},ly=function(a,b,c,d,e,f){a.J=ky;var g=new Map,h=_.co(b);g.set(h,{audioCapabilities:e,videoCapabilities:f,distinctiveIdentifier:_.$e,persistentState:_.If,sessionTypes:[_.ef],label:h,drmInfos:[{keySystem:b,licenseServerUri:c,distinctiveIdentifierRequired:!1,persistentStateRequired:!0,audioRobustness:"",
videoRobustness:"",serverCertificate:d,initData:null,keyIds:null}]});return _.Mn(a,g)},my=function(){this.g=new _.K(ey)},ny=function(a){a=JSON.parse(a);var b=JSON.parse(a.sessionIds),c=a.audioCapabilities||[],d=a.videoCapabilities||[],e=a.serverCertificate||[],f=a.drmConfig||{};return{sessionIds:b,keySystem:a.keySystem,licenseServerUri:decodeURIComponent(a.licenseServerUri||""),serverCertificate:e?new Uint8Array(e):null,audioCapabilities:c,videoCapabilities:d,drmConfig:f}},oy=function(a,b){var c=
_.Xl(a),d=_.Bl({drm:a});d.drm=a;var e=new _.xn({Gb:b,onError:function(){},yf:function(){},onExpirationUpdated:function(){},onEvent:function(){},getConfiguration:function(){return d},Sc:function(){return null}});e.h=c;return e},ry=function(a,b,c){var d,e,f,g,h,l,m,n,p;return _.E(function(q){switch(q.a){case 1:d=py;e=qy;if(!a)return e.debug(cy),q["return"]();f=a.offlineId;return 0===f.length?q["return"]():_.x(q,d.get(f),2);case 2:if(g=q.f)return e.debug(by,f),q["return"]();h=oy(a,c);_.A(q,3,4);return _.x(q,
jy(h,b),6);case 6:return _.x(q,_.Sn(h),7);case 7:return _.x(q,_.Tn(h),8);case 8:return l=h.getDrmInfo(),m=b.map(function(t){return{contentType:_.rk(t.video.mimeType,t.video.codecs),robustness:l.videoRobustness}}),n=gy(h),g={sessionIds:n,keySystem:l.keySystem,licenseServerUri:l.licenseServerUri,serverCertificate:l.serverCertificate,audioCapabilities:[],videoCapabilities:m,drmConfig:a},_.x(q,d.store(f,g),4);case 4:return _.bh(q),_.x(q,h.destroy(),10);case 10:_.ch(q,0);break;case 3:throw p=_.C(q),e.error("Error while persisting DRM session "+
f),new _.P(1,6,6200,null,p);}})},sy=function(){this.g=new _.K(dy)},iy=1,ky=2;_.r=my.prototype;
_.r.store=function(a,b){var c;return _.E(function(d){var e=JSON.stringify(b.sessionIds),f=b.serverCertificate?Array.from(b.serverCertificate):null;f=JSON.stringify(f);var g=JSON.stringify(b.audioCapabilities),h=JSON.stringify(b.videoCapabilities);c=JSON.stringify({sessionIds:e,keySystem:b.keySystem,licenseServerUri:encodeURIComponent(b.licenseServerUri),serverCertificate:f,audioCapabilities:g,videoCapabilities:h,drmConfig:JSON.stringify(b.drmConfig)});window.localStorage.setItem(encodeURIComponent(a),
btoa(c));_.y(d)})};_.r.get=function(a){var b=this,c;return _.E(function(d){if(c=window.localStorage.getItem(encodeURIComponent(a)))try{return d["return"](ny(atob(c)))}catch(e){b.g.warn("Error while loading offline items for "+a+" from storage: ",e)}return d["return"](null)})};_.r["delete"]=function(a){return _.E(function(b){window.localStorage.removeItem(encodeURIComponent(a));_.y(b)})};_.r.clear=function(){return _.E(function(a){window.localStorage.clear();_.y(a)})};_.r.getName=function(){return ey};_.H("clpp.persistent.useStorage",function(a){var b=["store","get","delete","clear","getName"];var c=[];_.N.R(a)||(_.N.rb(a.store)||c.push("store"),_.N.rb(a.get)||c.push("get"),_.N.rb(a["delete"])||c.push("delete"),_.N.rb(a.clear)||c.push("clear"),_.N.rb(a.getName)||c.push("getName"),b=c);if(0<b.length)throw qy.warn("Invalid session storage implementation"),new _.P(1,6,6202,{missingMethods:b});py=a});
_.H("clpp.persistent.fetchLicense",function(a,b,c){for(var d=[],e=2;e<arguments.length;++e)d[e-2]=arguments[e];var f,g,h,l,m,n,p,q,t,v,z,D,G,F,B,I,O,M,ba;return _.E(function(ha){switch(ha.a){case 1:f=py;g=qy;h=function(qa,Ta){return new _.P(1,6,6200,qa,Ta)};l=_.Zo(a).shift();if(!l)throw h("No source specified.");if(!b)throw h(cy);m=b.offlineId;if(typeof m!==_.Wf||!m.length)throw h("Missing offline id.");return _.x(ha,f.get(m),2);case 2:if(n=ha.f)return g.debug(by,m),ha["return"]();p=_.Bl();q=new _.Kj;
t=[];v=_.u(d);for(z=v.next();!z.done;z=v.next())D=z.value,G=new D,_.Fl(G.id())||(G.f(),_.Hl(G),t.push(G));F=null;_.A(ha,3,4);return _.x(ha,_.Cs(l.url,q,p.manifest.attemptParameters,l.type||null),6);case 6:return F=ha.f,F.configure(p.manifest),_.x(ha,F.start(l.url,{networkingEngine:q,filterAllPeriods:function(){},filterNewPeriod:function(){},onTimelineCueAdded:function(){},onEvent:function(){},onError:function(){}}),7);case 7:B=ha.f;if(!B.periods.length)throw h(null,new _.P(_.Q,4,4014));I=_.vs(B.periods);
return _.x(ha,ry(b,I,q),4);case 4:for(_.bh(ha);t.length;)O=t.shift(),O.a(),_.El["delete"](O.id());M=[];F&&M.push(F.stop());M.push(q.destroy());return _.x(ha,Promise.all(M),9);case 9:_.ch(ha,0);break;case 3:ba=_.C(ha);if(ba instanceof _.P&&6200===ba.code)throw ba;throw h(null,ba);}})});
_.H("clpp.persistent.removeLicense",function(a){var b,c,d,e,f,g,h;return _.E(function(l){switch(l.a){case 1:b=py;c=qy;if(!_.N.$(a)||0===a.length)return c.warn("Invalid offlineId"),l["return"]();e=d=null;_.A(l,2,3);return _.x(l,b.get(a),5);case 5:f=l.f;if(!f)return c.debug("No persistent DRM session found"),l["return"]();f.drmConfig.delayLicenseRequestUntilPlayed=!0;e=new _.Kj;d=oy(f.drmConfig,e);return _.x(l,ly(d,f.keySystem,f.licenseServerUri,f.serverCertificate,f.audioCapabilities,f.videoCapabilities),
6);case 6:return _.x(l,_.Sn(d),7);case 7:return _.x(l,Promise.all(f.sessionIds.map(function(m){return _.E(function(n){if(1==n.a)return _.x(n,hy(d,m),2);c.debug("successfully removed session with id",m);_.y(n)})})),8);case 8:return _.x(l,b["delete"](a),3);case 3:return _.bh(l),g=[],d&&g.push(d.destroy()),e&&g.push(e.destroy()),_.x(l,Promise.all(g),10);case 10:_.ch(l,0);break;case 2:throw h=_.C(l),c.error("Failed to remove session"),new _.P(1,6,6201,null,h);}})});var py=new my,qy=new _.K(dy);_.w(sy,_.Ir);sy.prototype.id=function(){return _.df};sy.prototype.l=function(a,b){var c=this,d,e,f;return _.E(function(g){if(1==g.a){d=a.getConfiguration().drm;if(!d)return c.g.debug("No DRM configuration found for loaded source."),g["return"]();c.g.debug("Persisting DRM session ID: "+d.offlineId);e=a.getNetworkEngine();_.A(g,2);return _.x(g,ry(d,b,e),4)}if(2!=g.a)return a.trigger(new _.L(_.ge,{offlineId:d.offlineId})),_.ah(g,0);f=_.C(g);a.onError(f);_.y(g)})};
sy.prototype.j=function(a){var b=this,c,d;return _.E(function(e){if(1==e.a)return b.g.debug("Getting EME session IDs for "+a),c=py,_.A(e,2),_.x(e,c.get(a),4);if(2!=e.a){if(d=e.f)return e["return"](d.sessionIds||[]);b.g.debug("No offline session found for "+a);return e["return"]([])}_.C(e);b.g.warn("Error while loading session info from storage");return e["return"]([])})};_.H("clpp.persistent.PersistentLicenseComponent",sy);};
if(typeof(module)!="undefined"&&module.exports){var x=require("./cl.core.js");_ = x._;(f.call(g,this));module.exports=g;}
else if (typeof(define)!="undefined"&&define.amd) {define(["./cl.core"], function(c){_=c._;(f.call(g,this));return g;});}
else{_=this.clpp._;(f.call(g,this));}
})();